name: Build Markdown Files

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: write
  pull-requests: write

jobs:
  build-markdown-files:
    runs-on: ubuntu-22.04  # Pin to Ubuntu 22.04 LTS
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Get changed Markdown files
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin ${{ github.event.pull_request.base.ref }}
          files=$(git diff --name-only FETCH_HEAD...HEAD -- '*.md' || true)
          files=$(printf "%s\n" "$files" | grep -v -E '(^|/)README\.md$' || true)
          if [ -z "$files" ]; then
            echo "No changed markdown files found"
            echo "files=" >> $GITHUB_OUTPUT
            exit 0
          fi
          {
            echo "files<<EOF"
            printf "%s\n" "$files"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Install non-TeX dependencies (cached)
        if: steps.changed.outputs.files != ''
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: pandoc default-jre curl
          version: 1.0

      - name: Install GraphViz (not cached)
        if: steps.changed.outputs.files != ''
        run: |
          sudo apt-get install -y graphviz

      - name: Install TeX Live (not cached)
        if: steps.changed.outputs.files != ''
        run: |
          sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-latex-recommended

      - name: Restore PlantUML JAR if cache
        if: steps.changed.outputs.files != ''
        id: cache-plantuml
        uses: actions/cache@v4
        with:
          path: plantuml.jar
          key: plantuml-v1.2026.0

      - name: Download PlantUML if not cached
        if: steps.changed.outputs.files != '' && steps.cache-plantuml.outputs.cache-hit != 'true'
        run: |
          curl -L -o plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2026.0/plantuml-1.2026.0.jar

      - name: Pre-render PlantUML diagrams
        if: steps.changed.outputs.files != ''
        shell: bash
        run: |
          set -euo pipefail
          files="${{ steps.changed.outputs.files }}"
          if [ -z "$files" ]; then
            echo "No files to process"
            exit 0
          fi
          WORKSPACE=$(pwd)
          
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            echo "Processing file: $f"
            dir=$(dirname "$f")
            base=$(basename "$f" .md)
            tmp=$(mktemp)
            cnt=0
            inside=0
            # Process file: extract plantuml blocks, write .uml files and replace blocks with image links
            while IFS= read -r line; do
              if [ $inside -eq 0 ] && [[ "$line" =~ ^'```'plantuml ]]; then
                inside=1
                cnt=$((cnt+1))
                umlfile="$WORKSPACE/$dir/${base}-plantuml-${cnt}.uml"
                pngfile="${base}-plantuml-${cnt}.png"
                : > "$umlfile"
                continue
              fi
              if [ $inside -eq 1 ]; then
                if [[ "$line" =~ ^'```' ]]; then
                  inside=0
                  # render UML to PNG
                  echo "Rendering PlantUML diagram $cnt for $f"
                  GRAPHVIZ_DOT=$(which dot) java -jar "$WORKSPACE/plantuml.jar" -tpng "$umlfile"
                  generated_png="${umlfile%.uml}.png"
                  if [ ! -f "$generated_png" ]; then
                    echo "ERROR: PlantUML did not generate $generated_png"
                    exit 1
                  fi
                  echo "PlantUML generated: $generated_png"
                  ls -lh "$generated_png"
                  echo "![]($pngfile)" >> "$tmp"
                  continue
                fi
                echo "$line" >> "$umlfile"
              else
                echo "$line" >> "$tmp"
              fi
            done < <(cat "$f"; echo)
            procfile="$WORKSPACE/$dir/${base}.processed.md"
            mv "$tmp" "$procfile"
          done < <(printf '%s\n' "$files")

      - name: Generate PDF files
        if: steps.changed.outputs.files != ''
        shell: bash
        run: |
          set -euo pipefail
          files="${{ steps.changed.outputs.files }}"
          WORKSPACE=$(pwd)
          
          # Identify conflicting basenames
          declare -A basename_count
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            base=$(basename "$f" .md)
            basename_count["$base"]=$((${basename_count["$base"]:-0} + 1))
          done < <(printf '%s\n' "$files")
          
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            dir=$(dirname "$f")
            base=$(basename "$f" .md)
            procfile="$WORKSPACE/$dir/${base}.processed.md"
            
            # Run pandoc from the markdown directory so relative image paths resolve
            (cd "$WORKSPACE/$dir" && pandoc "${base}.processed.md" -f markdown-implicit_figures --pdf-engine=xelatex -V geometry:margin=2cm -V mainfont="Liberation Serif" -V monofont="Liberation Mono" -o "${base}.pdf")
            echo "Built $dir/${base}.pdf"
            
            # Create filename for release - include path only if there's a conflict
            if [ "${basename_count[$base]}" -gt 1 ]; then
              release_pdf_name="${f%.md}"
              release_pdf_name="${release_pdf_name//\//-}.pdf"
            else
              release_pdf_name="${base}.pdf"
            fi
            cp "$WORKSPACE/$dir/${base}.pdf" "$WORKSPACE/$release_pdf_name"
            echo "Copied to $release_pdf_name for release"
          done < <(printf '%s\n' "$files")

      - name: Generate HTML files and create ZIP bundles
        if: steps.changed.outputs.files != ''
        shell: bash
        run: |
          set -euo pipefail
          files="${{ steps.changed.outputs.files }}"
          WORKSPACE=$(pwd)
          
          # Identify conflicting basenames
          declare -A basename_count
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            base=$(basename "$f" .md)
            basename_count["$base"]=$((${basename_count["$base"]:-0} + 1))
          done < <(printf '%s\n' "$files")
          
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            dir=$(dirname "$f")
            base=$(basename "$f" .md)
            procfile="$WORKSPACE/$dir/${base}.processed.md"
            
            # Generate HTML from processed markdown
            (cd "$WORKSPACE/$dir" && pandoc "${base}.processed.md" -f markdown-implicit_figures -o "${base}.html")
            echo "Built $dir/${base}.html"
            
            # Create ZIP filename for release - include path only if there's a conflict
            if [ "${basename_count[$base]}" -gt 1 ]; then
              release_zip_name="${f%.md}"
              release_zip_name="${release_zip_name//\//-} (html).zip"
            else
              release_zip_name="${base} (html).zip"
            fi
            
            # Create ZIP bundle with HTML and PlantUML PNGs
            (cd "$WORKSPACE/$dir" && zip -r "$WORKSPACE/$release_zip_name" "${base}.html" "${base}"-plantuml-*.png 2>/dev/null || zip "$WORKSPACE/$release_zip_name" "${base}.html")
            echo "Created $release_zip_name for release"
            
            # Cleanup generated files
            rm -f "$procfile"
            rm -f "$WORKSPACE/$dir/${base}.html"
            rm -f "$WORKSPACE/$dir/${base}"-plantuml-*.uml
            rm -f "$WORKSPACE/$dir/${base}"-plantuml-*.png
          done < <(printf '%s\n' "$files")

      - name: List files for release
        if: steps.changed.outputs.files != ''
        run: |
          echo "Files in workspace root:"
          ls -lh *.pdf *.zip 2>/dev/null || echo "No PDF or ZIP files found"

      - name: Create release with PDFs and HTML bundles
        if: steps.changed.outputs.files != ''
        id: create-release
        uses: ncipollo/release-action@v1
        with:
          tag: pr-${{ github.event.pull_request.number }}
          name: "Built Markdown files (#${{ github.event.pull_request.number }})"
          body: |
            Built Markdown files from PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
            
            Link to PR: ${{ github.event.pull_request.html_url }}
            
            ## Generated files:
            ${{ steps.changed.outputs.files }}
          artifacts: |
            *.pdf
            *.zip
          artifactContentType: application/octet-stream
          allowUpdates: true
          removeArtifacts: true
          prerelease: true
          makeLatest: false

      - name: Comment on PR with release link
        if: steps.changed.outputs.files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const files = `${{ steps.changed.outputs.files }}`.trim().split('\n').filter(f => f);
            const prNumber = ${{ github.event.pull_request.number }};
            const repo = context.repo;
            
            // Identify conflicting basenames
            const basenameCounts = {};
            files.forEach(f => {
              const base = f.split('/').pop().replace('.md', '');
              basenameCounts[base] = (basenameCounts[base] || 0) + 1;
            });
            
            const pdfList = files.map(f => {
              const base = f.split('/').pop().replace('.md', '');
              const pdfName = basenameCounts[base] > 1 
                ? f.replace('.md', '').replace(/\//g, '-') + '.pdf'
                : base + '.pdf';
              const zipName = basenameCounts[base] > 1
                ? f.replace('.md', '').replace(/\//g, '-') + ' (html).zip'
                : base + ' (html).zip';
              const pdfDownloadUrl = `https://github.com/${repo.owner}/${repo.repo}/releases/download/pr-${prNumber}/${pdfName}`;
              const zipDownloadUrl = `https://github.com/${repo.owner}/${repo.repo}/releases/download/pr-${prNumber}/${encodeURIComponent(zipName)}`;
              return `- ${f}\n  - [\`PDF\`](${pdfDownloadUrl})\n  - [\`HTML (zip)\`](${zipDownloadUrl})`;
            }).join('\n');
            
            const comment = `## ðŸ“„ Files generated from Markdown
            
            The following files have been generated:
            
            ${pdfList}
            
            [View Release: Built Markdown files (#${{ github.event.pull_request.number }})](${{ steps.create-release.outputs.html_url }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

